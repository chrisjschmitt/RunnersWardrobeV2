<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TrailKit - Recommendation Engine</title>
    <style>
        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --accent-orange: #f97316;
            --accent-blue: #3b82f6;
            --accent-green: #22c55e;
            --accent-yellow: #eab308;
            --accent-purple: #a855f7;
            --accent-red: #ef4444;
            --accent-cyan: #06b6d4;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            padding: 2rem;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            color: var(--accent-orange);
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 1.1rem;
            margin-bottom: 2rem;
        }

        h2 {
            font-size: 1.5rem;
            margin: 2rem 0 1rem;
            color: var(--accent-blue);
            border-bottom: 2px solid var(--bg-tertiary);
            padding-bottom: 0.5rem;
        }

        h3 {
            font-size: 1.2rem;
            margin: 1.5rem 0 0.75rem;
            color: var(--accent-cyan);
        }

        /* Flow diagram */
        .flow-diagram {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin: 1.5rem 0;
        }

        .flow-step {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 1.25rem;
            border-left: 4px solid var(--accent-orange);
            position: relative;
        }

        .flow-step::after {
            content: 'â†“';
            position: absolute;
            bottom: -1.5rem;
            left: 50%;
            transform: translateX(-50%);
            font-size: 1.5rem;
            color: var(--accent-orange);
        }

        .flow-step:last-child::after {
            display: none;
        }

        .flow-step.input {
            border-left-color: var(--accent-blue);
            background: linear-gradient(135deg, var(--bg-secondary) 0%, rgba(59, 130, 246, 0.1) 100%);
        }

        .flow-step.primary {
            border-left-color: var(--accent-green);
        }

        .flow-step.secondary {
            border-left-color: var(--accent-purple);
        }

        .flow-step.safety {
            border-left-color: var(--accent-red);
        }

        .flow-step.fallback {
            border-left-color: var(--accent-yellow);
            background: linear-gradient(135deg, var(--bg-secondary) 0%, rgba(234, 179, 8, 0.1) 100%);
        }

        .step-number {
            display: inline-block;
            background: var(--accent-orange);
            color: var(--bg-primary);
            width: 28px;
            height: 28px;
            border-radius: 50%;
            text-align: center;
            line-height: 28px;
            font-weight: bold;
            margin-right: 0.75rem;
        }

        .flow-step.input .step-number { background: var(--accent-blue); }
        .flow-step.primary .step-number { background: var(--accent-green); }
        .flow-step.secondary .step-number { background: var(--accent-purple); }
        .flow-step.safety .step-number { background: var(--accent-red); }
        .flow-step.fallback .step-number { background: var(--accent-yellow); color: var(--bg-primary); }

        .step-title {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }

        .step-description {
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        .step-detail {
            margin-top: 0.75rem;
            padding-left: 1rem;
            border-left: 2px solid var(--bg-tertiary);
        }

        .step-detail li {
            margin: 0.25rem 0;
            color: var(--text-secondary);
        }

        .confidence-badge {
            display: inline-block;
            background: var(--accent-green);
            color: var(--bg-primary);
            padding: 0.2rem 0.6rem;
            border-radius: 1rem;
            font-size: 0.8rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }

        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
            background: var(--bg-secondary);
            border-radius: 8px;
            overflow: hidden;
        }

        th, td {
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid var(--bg-tertiary);
        }

        th {
            background: var(--bg-tertiary);
            font-weight: 600;
            color: var(--accent-orange);
        }

        tr:last-child td {
            border-bottom: none;
        }

        tr:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        .weight-high { color: var(--accent-green); font-weight: 600; }
        .weight-medium { color: var(--accent-yellow); }
        .weight-low { color: var(--text-secondary); }

        /* Key takeaways */
        .takeaways {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1rem;
            margin: 1.5rem 0;
        }

        .takeaway {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 1.25rem;
            display: flex;
            gap: 1rem;
            align-items: flex-start;
        }

        .takeaway-icon {
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .takeaway-content strong {
            display: block;
            margin-bottom: 0.25rem;
            color: var(--text-primary);
        }

        .takeaway-content p {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        /* Temperature ranges */
        .temp-ranges {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin: 1rem 0;
        }

        .temp-badge {
            padding: 0.4rem 0.8rem;
            border-radius: 2rem;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .temp-extremecold { background: #1e1b4b; color: #818cf8; }
        .temp-freezing { background: #1e3a5f; color: #93c5fd; }
        .temp-verycold { background: #1e3a5f; color: #60a5fa; }
        .temp-cold { background: #164e63; color: #67e8f9; }
        .temp-cool { background: #134e4a; color: #5eead4; }
        .temp-mild { background: #365314; color: #bef264; }
        .temp-warm { background: #713f12; color: #fcd34d; }
        .temp-hot { background: #7c2d12; color: #fdba74; }

        /* Safety overrides section */
        .safety-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 0.75rem;
            margin: 1rem 0;
        }

        .safety-item {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 0.75rem 1rem;
            border-left: 3px solid var(--accent-red);
            font-size: 0.9rem;
        }

        .safety-item .condition {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .safety-item .action {
            color: var(--accent-green);
            margin-top: 0.25rem;
        }

        /* Footer */
        .footer {
            margin-top: 3rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--bg-tertiary);
            color: var(--text-secondary);
            font-size: 0.9rem;
            text-align: center;
        }

        .version {
            display: inline-block;
            background: var(--accent-orange);
            color: var(--bg-primary);
            padding: 0.2rem 0.6rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        /* Responsive */
        @media (max-width: 600px) {
            body {
                padding: 1rem;
            }
            
            h1 {
                font-size: 1.75rem;
            }
            
            .flow-step {
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§  Recommendation Engine</h1>
        <p class="subtitle">How TrailKit decides what clothes to recommend for your outdoor activities</p>

        <h2>ğŸ“Š The Recommendation Flow</h2>
        
        <div class="flow-diagram">
            <div class="flow-step input">
                <div class="step-title">
                    <span class="step-number">â¬‡</span>
                    Current Weather Input
                </div>
                <p class="step-description">
                    Temperature, feels like, humidity, wind speed, precipitation, UV index, and cloud cover
                </p>
            </div>

            <div class="flow-step">
                <div class="step-title">
                    <span class="step-number">1</span>
                    Calculate T_comfort
                </div>
                <p class="step-description">
                    Calculate a comfort-adjusted temperature based on activity, weather, and preferences
                </p>
                <div class="formula-box" style="background: var(--bg-tertiary); padding: 1rem; border-radius: 8px; margin: 0.75rem 0; font-family: monospace;">
                    <strong>T_comfort = T_actual + B(activity) + I(intensity) + wÎ” Ã— Î” + thermal_offset</strong>
                    <br><span style="color: var(--text-secondary); font-size: 0.9rem;">Where Î” = clamp(FeelsLike âˆ’ Actual, âˆ’15Â°C, +8Â°C)</span>
                </div>
                <ul class="step-detail">
                    <li><strong>B(activity)</strong> â€” Body heat adjustment: +0.5Â°C walking â†’ +6Â°C running</li>
                    <li><strong>I(intensity)</strong> â€” Activity intensity (Expert Mode): âˆ’1.5Â°C (low) / 0 (moderate) / +1.5Â°C (high)</li>
                    <li><strong>wÎ” Ã— Î”</strong> â€” Weighted feels-like effect: 0.35 (running) â†’ 0.80 (walking)</li>
                    <li><strong>thermal_offset</strong> â€” User preference: âˆ’4.4Â°C (cold) / 0 / +4.4Â°C (warm)</li>
                </ul>
                <p class="step-description" style="margin-top: 0.75rem; font-size: 0.9rem; color: var(--text-secondary);">
                    <em>Higher B = more body heat = lighter clothing. Higher intensity = more body heat = raises T_comfort. Higher wÎ” = more affected by wind chill.</em>
                </p>
            </div>

            <div class="flow-step primary">
                <div class="step-title">
                    <span class="step-number">2</span>
                    Exact Recent Match (Last 7 Days)
                    <span class="confidence-badge">Variable confidence</span>
                </div>
                <p class="step-description">
                    If you did this activity in very similar weather (&gt;85% match) in the past week, use exactly what you wore
                </p>
                <ul class="step-detail">
                    <li><strong>Uses activity-specific thresholds:</strong> Walking uses Â±1.5Â°C, Running uses Â±3.5Â°C, etc.</li>
                    <li><strong>Confidence calculated from actual similarity:</strong> (1/5) Ã— 30% + similarity Ã— 70%</li>
                    <li><strong>No longer hardcoded to 95%:</strong> Confidence reflects true match quality (v4.22.1)</li>
                </ul>
            </div>

            <div class="flow-step secondary">
                <div class="step-title">
                    <span class="step-number">3</span>
                    Find Similar Sessions
                </div>
                <p class="step-description">
                    Compare current weather to all past runs & feedback with &gt;40% similarity
                </p>
                <ul class="step-detail">
                    <li><strong>Feedback records</strong> get 2Ã— weight (you rated them!)</li>
                    <li><strong>Recent sessions</strong> get a recency multiplier (up to 1.05Ã—)</li>
                    <li><strong>"Just right" or "satisfied"</strong> comfort ratings get a comfort multiplier (1.05Ã—)</li>
                    <li><strong>Activity level matching:</strong> Historical sessions use their stored activity level for accurate T_comfort comparison</li>
                    <li><strong>Legacy "medium" values</strong> are automatically normalized to "moderate" for backward compatibility</li>
                </ul>
            </div>

            <div class="flow-step secondary">
                <div class="step-title">
                    <span class="step-number">4</span>
                    Vote for Each Clothing Category
                </div>
                <p class="step-description">
                    For each category (tops, bottoms, gloves, head cover, etc.):
                </p>
                <ul class="step-detail">
                    <li>Collect what you wore in similar conditions</li>
                    <li>Higher similarity = more votes</li>
                    <li>Pick the most common choice</li>
                </ul>
            </div>

            <div class="flow-step secondary">
                <div class="step-title">
                    <span class="step-number">4.5</span>
                    Temperature Adjustment
                </div>
                <p class="step-description">
                    If current T_comfort is significantly colder/warmer than historical matches, adjust clothing accordingly
                </p>
                <ul class="step-detail">
                    <li>Compares current T_comfort to average T_comfort of similar sessions</li>
                    <li>If current is â‰¥3Â°C colder, upgrades clothing to warmer options</li>
                    <li>Upgrades base layer, mid-layer, and outer layer as needed</li>
                    <li>Ensures recommendations match CURRENT conditions, not just historical averages</li>
                </ul>
            </div>

            <div class="flow-step safety">
                <div class="step-title">
                    <span class="step-number">5</span>
                    Smart Safety Overrides
                </div>
                <p class="step-description">
                    Prevent dangerous recommendations that could leave you freezing or unprepared
                </p>
            </div>

            <div class="flow-step fallback">
                <div class="step-title">
                    <span class="step-number">âœ¦</span>
                    Fallback: Activity Defaults
                </div>
                <p class="step-description">
                    If no similar history exists, use predefined defaults based on temperature range and activity type
                </p>
            </div>
        </div>

        <h2>âš–ï¸ T_comfort-Based Matching</h2>
        <p>Similarity matching uses T_comfort as the primary metric (replaces separate temp/feels-like/wind matching):</p>
        
        <table>
            <thead>
                <tr>
                    <th>Factor</th>
                    <th>Weight</th>
                    <th>Threshold</th>
                    <th>Score Formula</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>T_comfort</strong></td>
                    <td class="weight-high">5.0</td>
                    <td>Activity-specific (see below)</td>
                    <td>100% within threshold, sliding scale to 0% at 2Ã— threshold, filtered if &gt;2Ã— threshold</td>
                </tr>
                <tr>
                    <td><strong>Precipitation</strong></td>
                    <td class="weight-medium">2.5</td>
                    <td>Yes/No</td>
                    <td>100% if both match, 30% if different</td>
                </tr>
                <tr>
                    <td><strong>UV Index</strong></td>
                    <td class="weight-low">0.5</td>
                    <td>Â±2</td>
                    <td>Perfect if â‰¤2 diff, 0% if &gt;4 diff</td>
                </tr>
            </tbody>
        </table>

        <h3>ğŸ¯ Activity-Specific T_comfort Thresholds (v4.22.0+)</h3>
        <p style="color: var(--text-secondary);">Each activity has its own T_comfort tolerance based on intensity and typical conditions:</p>
        <table>
            <thead>
                <tr>
                    <th>Activity</th>
                    <th>Perfect Match</th>
                    <th>Sliding Scale</th>
                    <th>Filtered Out</th>
                    <th>Logic</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>Walking</strong></td>
                    <td>Â±1.5Â°C</td>
                    <td>1.5Â°C to 3.0Â°C</td>
                    <td>&gt;3.0Â°C</td>
                    <td>Low intensity, need precise matches</td>
                </tr>
                <tr>
                    <td><strong>Hiking</strong></td>
                    <td>Â±2.0Â°C</td>
                    <td>2.0Â°C to 4.0Â°C</td>
                    <td>&gt;4.0Â°C</td>
                    <td>Moderate intensity, moderate tolerance</td>
                </tr>
                <tr>
                    <td><strong>Snowshoeing</strong></td>
                    <td>Â±2.5Â°C</td>
                    <td>2.5Â°C to 5.0Â°C</td>
                    <td>&gt;5.0Â°C</td>
                    <td>Variable intensity, some tolerance</td>
                </tr>
                <tr>
                    <td><strong>XC Skiing</strong></td>
                    <td>Â±3.0Â°C</td>
                    <td>3.0Â°C to 6.0Â°C</td>
                    <td>&gt;6.0Â°C</td>
                    <td>High intensity, more tolerance</td>
                </tr>
                <tr>
                    <td><strong>Trail Running</strong></td>
                    <td>Â±3.0Â°C</td>
                    <td>3.0Â°C to 6.0Â°C</td>
                    <td>&gt;6.0Â°C</td>
                    <td>High intensity, more tolerance</td>
                </tr>
                <tr>
                    <td><strong>Cycling</strong></td>
                    <td>Â±3.0Â°C</td>
                    <td>3.0Â°C to 6.0Â°C</td>
                    <td>&gt;6.0Â°C</td>
                    <td>High intensity, more tolerance</td>
                </tr>
                <tr>
                    <td><strong>Running</strong></td>
                    <td>Â±3.5Â°C</td>
                    <td>3.5Â°C to 7.0Â°C</td>
                    <td>&gt;7.0Â°C</td>
                    <td>Highest intensity, most tolerance</td>
                </tr>
            </tbody>
        </table>
        <p style="color: var(--text-secondary); margin-top: 0.5rem; font-size: 0.9rem;">
            <strong>Scoring:</strong> Within threshold = 100% score. Between threshold and 2Ã— threshold = sliding scale (2 - diff/threshold). Beyond 2Ã— threshold = 0% score and filtered out early.
        </p>

        <h2>ğŸƒ Activity Thermal Parameters</h2>
        <p>Each activity has specific parameters for T_comfort calculation:</p>
        
        <table>
            <thead>
                <tr>
                    <th>Activity</th>
                    <th>B (Base) Â°C</th>
                    <th>wÎ” (Feels-Like Weight)</th>
                    <th>Logic</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>Walking</strong></td>
                    <td>+0.5</td>
                    <td>0.80</td>
                    <td>Low body heat, high wind impact</td>
                </tr>
                <tr>
                    <td><strong>Hiking</strong></td>
                    <td>+2.0</td>
                    <td>0.65</td>
                    <td>Moderate heat, moderate wind</td>
                </tr>
                <tr>
                    <td><strong>Snowshoeing</strong></td>
                    <td>+3.0</td>
                    <td>0.60</td>
                    <td>Good heat, some wind buffer from layers</td>
                </tr>
                <tr>
                    <td><strong>Cycling</strong></td>
                    <td>+4.0</td>
                    <td>0.50</td>
                    <td>High heat, but wind is consistent</td>
                </tr>
                <tr>
                    <td><strong>XC Skiing</strong></td>
                    <td>+4.5</td>
                    <td>0.50</td>
                    <td>Very high heat, good wind protection</td>
                </tr>
                <tr>
                    <td><strong>Trail Running</strong></td>
                    <td>+5.5</td>
                    <td>0.40</td>
                    <td>Very high heat, wind matters less</td>
                </tr>
                <tr>
                    <td><strong>Running</strong></td>
                    <td>+6.0</td>
                    <td>0.35</td>
                    <td>Highest heat, least wind impact</td>
                </tr>
            </tbody>
        </table>

        <h3>ğŸ“ Example T_comfort Calculation</h3>
        <p style="color: var(--text-secondary); margin-bottom: 1rem;">
            <strong>Scenario:</strong> Running, 5Â°C actual, 0Â°C feels-like, User "runs cold"
        </p>
        <table>
            <thead>
                <tr>
                    <th>Component</th>
                    <th>Value</th>
                    <th>Description</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>T_actual</td>
                    <td class="weight-high">5Â°C</td>
                    <td>Current temperature</td>
                </tr>
                <tr>
                    <td>Î” (delta)</td>
                    <td>-5Â°C</td>
                    <td>FeelsLike - Actual = 0 - 5 = -5Â°C</td>
                </tr>
                <tr>
                    <td>B (Running)</td>
                    <td class="weight-high">+6.0Â°C</td>
                    <td>Base body heat for running</td>
                </tr>
                <tr>
                    <td>wÎ” (Running)</td>
                    <td>0.35</td>
                    <td>Feels-like weight for running</td>
                </tr>
                <tr>
                    <td>wÎ” Ã— Î”</td>
                    <td class="weight-medium">-1.75Â°C</td>
                    <td>0.35 Ã— -5 = -1.75Â°C wind chill effect</td>
                </tr>
                <tr>
                    <td>Thermal offset</td>
                    <td class="weight-medium">-4.4Â°C</td>
                    <td>User "runs cold" â†’ lower T_comfort â†’ warmer clothes</td>
                </tr>
                <tr style="background: var(--bg-tertiary);">
                    <td colspan="2"><strong>T_comfort</strong></td>
                    <td><strong style="color: var(--accent-green);">5 + 6.0 - 1.75 - 4.4 = 4.85Â°C</strong></td>
                </tr>
            </tbody>
        </table>

        <h3>ğŸ“ Example Similarity Matching</h3>
        <p style="color: var(--text-secondary); margin-bottom: 1rem;">
            Current T_comfort: <strong>10Â°C</strong>, no rain, UV 3<br>
            Historical T_comfort: <strong>12Â°C</strong>, no rain, UV 4
        </p>
        <table>
            <thead>
                <tr>
                    <th>Factor</th>
                    <th>Difference</th>
                    <th>Score</th>
                    <th>Ã— Weight</th>
                    <th>= Weighted</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>T_comfort</td>
                    <td>2Â°C</td>
                    <td>1 - (2/6) = 0.67</td>
                    <td>Ã— 5.0</td>
                    <td class="weight-high">3.33</td>
                </tr>
                <tr>
                    <td>Precipitation</td>
                    <td>match</td>
                    <td>1.00</td>
                    <td>Ã— 2.5</td>
                    <td class="weight-medium">2.50</td>
                </tr>
                <tr>
                    <td>UV Index</td>
                    <td>1</td>
                    <td>1 - (1/4) = 0.75</td>
                    <td>Ã— 0.5</td>
                    <td class="weight-low">0.38</td>
                </tr>
                <tr style="background: var(--bg-tertiary);">
                    <td colspan="4"><strong>Total</strong></td>
                    <td><strong style="color: var(--accent-green);">6.21 / 8.0 = 78%</strong></td>
                </tr>
            </tbody>
        </table>

        <h2>ğŸ—³ï¸ Voting System</h2>
        <p>Once similar sessions are found, the app uses a voting system to pick clothing:</p>
        
        <div class="flow-step secondary" style="margin: 1rem 0;">
            <div class="step-title">How Votes Work</div>
            <ul class="step-detail">
                <li>Each similar session "votes" for the clothing items it used</li>
                <li><strong>Higher similarity = more votes:</strong> <code>votes = ceil(score Ã— 3)</code></li>
                <li><strong>Feedback sessions get 2Ã— votes</strong> compared to CSV imports</li>
                <li>The item with the most votes wins for each clothing category</li>
            </ul>
        </div>

        <h3>ğŸ“Š Voting Example</h3>
        <p style="color: var(--text-secondary); margin-bottom: 0.5rem;">3 similar sessions found for "tops" category:</p>
        <table>
            <thead>
                <tr>
                    <th>Session</th>
                    <th>Match %</th>
                    <th>Source</th>
                    <th>Wore</th>
                    <th>Votes</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Session A</td>
                    <td>80%</td>
                    <td>ğŸ“ Feedback</td>
                    <td>Long sleeve</td>
                    <td class="weight-high">ceil(0.8 Ã— 3) Ã— 2 = 6</td>
                </tr>
                <tr>
                    <td>Session B</td>
                    <td>60%</td>
                    <td>ğŸ“„ CSV</td>
                    <td>T-shirt</td>
                    <td class="weight-low">ceil(0.6 Ã— 3) Ã— 1 = 2</td>
                </tr>
                <tr>
                    <td>Session C</td>
                    <td>50%</td>
                    <td>ğŸ“ Feedback</td>
                    <td>Long sleeve</td>
                    <td class="weight-medium">ceil(0.5 Ã— 3) Ã— 2 = 4</td>
                </tr>
            </tbody>
        </table>
        <p style="margin-top: 0.5rem;">
            <strong style="color: var(--accent-green);">Result:</strong> Long sleeve (10 votes) beats T-shirt (2 votes) â†’ <strong>Long sleeve wins!</strong>
        </p>

        <h3>ğŸš€ Feedback Multipliers</h3>
        <p style="color: var(--text-secondary);">Sessions from user feedback get additional score multipliers before voting (v4.18+):</p>
        <table>
            <thead>
                <tr>
                    <th>Multiplier Type</th>
                    <th>Amount</th>
                    <th>Formula</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>Recency Multiplier</strong></td>
                    <td>Up to 1.05Ã— (5%)</td>
                    <td><code>1.0 + (0.05 Ã— min(1, 7 / days_ago))</code></td>
                </tr>
                <tr>
                    <td><strong>Comfort Multiplier</strong></td>
                    <td>1.05Ã— (5%)</td>
                    <td>If session was marked "satisfied" (v4.9+) or "just right" (legacy)</td>
                </tr>
            </tbody>
        </table>
        <p style="color: var(--text-secondary); margin-top: 0.5rem; font-size: 0.9rem;">
            <strong>Note:</strong> Multipliers are small (up to 5%) and act as tie-breakers. Weather similarity remains the primary factor. 
            Example: A "satisfied" session from yesterday gets: base score Ã— 1.05 (recency) Ã— 1.05 (comfort) = up to 10% total boost.
        </p>
        
        <h3>âœ… New Feedback Flow (v4.9+)</h3>
        <p style="color: var(--text-secondary);">After each activity, users answer "Were you satisfied with your outfit?":</p>
        <ul class="step-detail">
            <li><strong>Yes</strong> â†’ Outfit saved as "satisfied", gets boost in future recommendations</li>
            <li><strong>No, make changes</strong> â†’ User edits clothing items â†’ Adjusted outfit saved</li>
        </ul>
        <p style="color: var(--text-secondary); margin-top: 0.5rem; font-size: 0.9rem;">
            <em>The app learns from what you actually wore, especially when you adjust the recommendation before saving.</em>
        </p>

        <h2>ğŸ“ˆ Confidence Calculation</h2>
        <p>The confidence percentage shown in the app reflects both the <strong>quality</strong> and <strong>quantity</strong> of matching sessions. When confidence is Medium or Low, the app may provide suggestions for clothing adjustments.</p>
        
        <div class="flow-step secondary" style="margin: 1rem 0;">
            <div class="step-title">Confidence Formula</div>
            <pre style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px; overflow-x: auto; margin-top: 0.5rem;">
confidence = (sessionCount / 5) Ã— 30%  +  avgSimilarity Ã— 70%
            </pre>
            <ul class="step-detail" style="margin-top: 0.5rem;">
                <li><strong>30% weight</strong> for session count (capped at 5 sessions)</li>
                <li><strong>70% weight</strong> for average match quality of similar sessions</li>
                <li>Maximum confidence: 100%</li>
                <li><em>Note: Reduced from 10 to 5 sessions (v4.21.5) for more realistic confidence with fewer data points</em></li>
                <li><em>Note: Activity-specific T_comfort thresholds (v4.22.0) ensure each activity uses appropriate matching tolerance</em></li>
            </ul>
        </div>

        <h3>ğŸ“Š Confidence Examples</h3>
        <table>
            <thead>
                <tr>
                    <th>Scenario</th>
                    <th>Session Count</th>
                    <th>Avg Match</th>
                    <th>Confidence</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>2 very close matches</td>
                    <td>(2/5) Ã— 30 = 12</td>
                    <td>97% Ã— 70 = 68</td>
                    <td><strong style="color: var(--accent-green);">80%</strong></td>
                </tr>
                <tr>
                    <td>5 good matches</td>
                    <td>(5/5) Ã— 30 = 30</td>
                    <td>85% Ã— 70 = 60</td>
                    <td><strong style="color: var(--accent-green);">90%</strong></td>
                </tr>
                <tr>
                    <td>5+ excellent matches</td>
                    <td>(5/5) Ã— 30 = 30</td>
                    <td>90% Ã— 70 = 63</td>
                    <td><strong style="color: var(--accent-green);">93%</strong></td>
                </tr>
                <tr>
                    <td>1 perfect match</td>
                    <td>(1/5) Ã— 30 = 6</td>
                    <td>100% Ã— 70 = 70</td>
                    <td><strong style="color: var(--accent-green);">76%</strong></td>
                </tr>
            </tbody>
        </table>
        <p style="color: var(--text-secondary); margin-top: 0.5rem; font-size: 0.9rem;">
            <em>This weighting means a few very close matches can still produce high confidence, while more sessions provide additional reliability.</em>
        </p>

        <h3>ğŸ’¡ Low/Medium Confidence Suggestions</h3>
        <p style="color: var(--text-secondary);">When confidence is below 70% (Medium or Low), the app can provide contextual suggestions:</p>
        <ul class="step-detail">
            <li><strong>Compares current recommendation</strong> to activity defaults and weather conditions</li>
            <li><strong>Identifies potential gaps</strong> (e.g., missing mid-layer in cold conditions)</li>
            <li><strong>Provides specific recommendations</strong> with reasoning (e.g., "Add a mid-layer - current conditions are colder than your historical matches")</li>
            <li><strong>Category-by-category suggestions</strong> showing current vs. recommended items</li>
        </ul>
        <p style="color: var(--text-secondary); margin-top: 0.5rem; font-size: 0.9rem;">
            <em>Note: Suggestions feature is currently being refined and may be temporarily disabled in some versions.</em>
        </p>

        <h2>ğŸ›¡ï¸ Safety Overrides</h2>
        <p>Safety overrides fire <strong>after voting</strong> to prevent dangerous recommendations. They only trigger if the voted result is inadequate (e.g., "None" for gloves when it's freezing).</p>
        
        <table>
            <thead>
                <tr>
                    <th>Category</th>
                    <th>Condition</th>
                    <th>Override Action</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>Tops</strong></td>
                    <td>&lt;25Â°F + t-shirt/tank</td>
                    <td>â†’ Base layer + jacket</td>
                </tr>
                <tr>
                    <td></td>
                    <td>&lt;40Â°F + t-shirt/tank</td>
                    <td>â†’ Long sleeve</td>
                </tr>
                <tr>
                    <td><strong>Head Cover</strong></td>
                    <td>&lt;40Â°F + "None"</td>
                    <td>â†’ Headband</td>
                </tr>
                <tr>
                    <td></td>
                    <td>&lt;25Â°F + "None"</td>
                    <td>â†’ Beanie</td>
                </tr>
                <tr>
                    <td><strong>Bottoms</strong></td>
                    <td>&lt;45Â°F + shorts</td>
                    <td>â†’ Tights</td>
                </tr>
                <tr>
                    <td></td>
                    <td>&lt;25Â°F + shorts</td>
                    <td>â†’ Insulated pants</td>
                </tr>
                <tr>
                    <td><strong>Shoes</strong></td>
                    <td>&lt;32Â°F or rain/snow</td>
                    <td>â†’ Waterproof footwear</td>
                </tr>
                <tr>
                    <td><strong>Rain Gear</strong></td>
                    <td>Raining + "None"</td>
                    <td>â†’ Rain jacket</td>
                </tr>
                <tr>
                    <td><strong>Accessories</strong></td>
                    <td>Sunny conditions</td>
                    <td>â†’ Sunglasses</td>
                </tr>
                <tr>
                    <td></td>
                    <td>Dark / near sunset</td>
                    <td>â†’ Headlamp</td>
                </tr>
            </tbody>
        </table>
        
        <p style="color: var(--text-secondary); margin-top: 1rem; font-size: 0.9rem;">
            <strong>Note:</strong> Overrides only kick in if the voted result is inadequate. Your personal preferences from history are respected â€” overrides are a last-resort safety net.
        </p>
        <p style="color: var(--text-secondary); margin-top: 0.5rem; font-size: 0.85rem;">
            <strong>Why no gloves override?</strong> Activity defaults already recommend appropriate gloves based on temperature, and users may have valid preferences (mittens, light gloves, etc.) that shouldn't be overridden.
        </p>

        <h3>âš ï¸ Extreme Temperature Warnings</h3>
        <p style="color: var(--text-secondary);">When T_comfort falls outside safe ranges, a warning banner is displayed:</p>
        <table>
            <thead>
                <tr>
                    <th>Condition</th>
                    <th>Threshold</th>
                    <th>Warning</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td style="color: #dc2626;"><strong>âš ï¸ Dangerous Cold</strong></td>
                    <td>T_comfort &lt; -15Â°C (5Â°F)</td>
                    <td>Strong warning about potential lung damage. Recommends moving indoors, reducing intensity, or using mask/buff to warm air. Full body coverage essential.</td>
                </tr>
                <tr>
                    <td style="color: #f87171;"><strong>â„ï¸ Extreme Cold</strong></td>
                    <td>T_comfort &lt; -9.4Â°C (15Â°F)</td>
                    <td>"Full coverage recommended. Protect exposed skin."</td>
                </tr>
                <tr>
                    <td style="color: #fb923c;"><strong>ğŸ”¥ Extreme Heat</strong></td>
                    <td>T_comfort &gt; 29.4Â°C (85Â°F)</td>
                    <td>"Prioritize cooling and hydration."</td>
                </tr>
            </tbody>
        </table>
        <p style="color: var(--text-secondary); margin-top: 0.5rem; font-size: 0.9rem;">
            These warnings appear both before starting and during your activity. The dangerous cold warning is based on research showing temperatures below -15Â°C can cause permanent lung damage.
        </p>

        <h2>ğŸŒ¡ï¸ Temperature Ranges (Fallback Defaults)</h2>
        <p>When no history exists, the app uses activity-specific defaults for these temperature ranges:</p>
        
        <div class="temp-ranges">
            <span class="temp-badge temp-extremecold">âš ï¸ Extreme Cold: &lt;5Â°F</span>
            <span class="temp-badge temp-freezing">â„ï¸ Freezing: 5-15Â°F</span>
            <span class="temp-badge temp-verycold">ğŸ¥¶ Very Cold: 15-25Â°F</span>
            <span class="temp-badge temp-cold">ğŸ§Š Cold: 25-40Â°F</span>
            <span class="temp-badge temp-cool">ğŸƒ Cool: 40-55Â°F</span>
            <span class="temp-badge temp-mild">ğŸŒ¤ï¸ Mild: 55-65Â°F</span>
            <span class="temp-badge temp-warm">â˜€ï¸ Warm: 65-75Â°F</span>
            <span class="temp-badge temp-hot">ğŸ”¥ Hot: &gt;75Â°F</span>
        </div>
        
        <p style="color: var(--text-secondary); margin-top: 1rem;">
            Each activity (Running, Cycling, Walking, etc.) has its own set of defaults for each temperature range.
            The extremeCold range includes more protective gear (mittens, neck gaiters, expedition-weight base layers) based on research showing temperatures below -15Â°C can be harmful to lung health.
            For example, Cycling defaults include helmet, jersey, and cycling shoes, while Walking includes more casual options.
        </p>

        <h2>ğŸ¯ Key Takeaways</h2>
        
        <div class="takeaways">
            <div class="takeaway">
                <span class="takeaway-icon">â­</span>
                <div class="takeaway-content">
                    <strong>Your Feedback Matters Most</strong>
                    <p>Sessions where you gave feedback count 2Ã— more than imported history</p>
                </div>
            </div>
            <div class="takeaway">
                <span class="takeaway-icon">ğŸ•</span>
                <div class="takeaway-content">
                    <strong>Recent = Better</strong>
                    <p>Sessions from the last 30 days get a recency boost in matching</p>
                </div>
            </div>
            <div class="takeaway">
                <span class="takeaway-icon">ğŸ‘</span>
                <div class="takeaway-content">
                    <strong>"Just Right" Wins</strong>
                    <p>If you marked a session as comfortable, those choices are prioritized</p>
                </div>
            </div>
            <div class="takeaway">
                <span class="takeaway-icon">ğŸ›¡ï¸</span>
                <div class="takeaway-content">
                    <strong>Safety First</strong>
                    <p>The app won't let you freeze â€” safety overrides kick in for extreme temps</p>
                </div>
            </div>
            <div class="takeaway">
                <span class="takeaway-icon">ğŸƒ</span>
                <div class="takeaway-content">
                    <strong>Activity-Specific</strong>
                    <p>Each of the 7 activities has its own clothing options and defaults</p>
                </div>
            </div>
            <div class="takeaway">
                <span class="takeaway-icon">ğŸ“ˆ</span>
                <div class="takeaway-content">
                    <strong>It Gets Smarter</strong>
                    <p>The more you use it and give feedback, the better recommendations become</p>
                </div>
            </div>
        </div>

        <h2>ğŸ”§ Source Files</h2>
        <table>
            <thead>
                <tr>
                    <th>File</th>
                    <th>Purpose</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><code>src/services/recommendationEngine.ts</code></td>
                    <td>Main recommendation logic, similarity calculations, voting system</td>
                </tr>
                <tr>
                    <td><code>src/data/activityDefaults.ts</code></td>
                    <td>Activity-specific defaults for each temperature range</td>
                </tr>
                <tr>
                    <td><code>src/types/index.ts</code></td>
                    <td>Clothing categories, activity configurations, helper functions</td>
                </tr>
            </tbody>
        </table>

        <div class="footer">
            <span class="version">v4.22.1</span>
            <p style="margin-top: 0.5rem;">TrailKit Recommendation Engine Documentation</p>
            <p>Â© 2025 TrailKit</p>
        </div>
    </div>
</body>
</html>

